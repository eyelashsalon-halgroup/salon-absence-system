# 📋 HALサロン予約システム - 完全マニュアル v11.0

**最終更新**: 2026年1月8日 10:50 JST  
**バージョン**: 11.0  
**作成者**: Claude + 神原 良祐

---

## 📖 目次

1. [システム概要](#1-システム概要)
2. [完了機能一覧](#2-完了機能一覧)
3. [未完・進行中機能](#3-未完進行中機能)
4. [インフラ構成](#4-インフラ構成)
5. [ファイル構成](#5-ファイル構成)
6. [データベース設計](#6-データベース設計)
7. [フロントエンド（LIFF）](#7-フロントエンドliff)
8. [バックエンド（Railway）](#8-バックエンドrailway)
9. [スクレイピングシステム](#9-スクレイピングシステム)
10. [キャンセル・変更自動化](#10-キャンセル変更自動化)
11. [通知システム](#11-通知システム)
12. [セキュリティ設定](#12-セキュリティ設定)
13. [運用手順](#13-運用手順)
14. [トラブルシューティング](#14-トラブルシューティング)

---

## 1. システム概要

### 全体アーキテクチャ

\`\`\`
┌─────────────────────────────────────────────────────────────────────────────┐
│                    eyelashsalon HAL 予約管理システム                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【顧客側】                                                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                     │
│  │    LINE     │───▶│    LIFF     │───▶│  Railway    │                     │
│  │ リッチメニュー │    │  予約確認   │    │   API      │                     │
│  └─────────────┘    │  日時変更   │    └──────┬──────┘                     │
│                     │  キャンセル  │           │                            │
│                     └─────────────┘           ▼                            │
│                                        ┌─────────────┐                     │
│  【バックエンド】                        │  Supabase   │                     │
│  ┌─────────────────────────────────┐   │  PostgreSQL │                     │
│  │  auth_notification_system.py    │◀─▶│  (RLS有効)  │                     │
│  │  ├─ Flask Webサーバー           │   └─────────────┘                     │
│  │  ├─ LIFF APIエンドポイント       │           ▲                            │
│  │  ├─ APScheduler（定期実行）      │           │                            │
│  │  └─ SalonBoard自動操作          │   ┌───────┴───────┐                   │
│  └─────────────────────────────────┘   │               │                   │
│                                        ▼               ▼                   │
│  【外部連携】                    ┌───────────┐  ┌───────────┐              │
│                                 │ SalonBoard │  │  LINE API │              │
│                                 │  予約取得  │  │  通知送信  │              │
│                                 │  キャンセル │  └───────────┘              │
│                                 └───────────┘                              │
│                                                                             │
│  【自動処理】                                                                │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                     │
│  │ 毎分実行    │───▶│ scrape_     │───▶│  DB保存     │                     │
│  │ スクレイピング│    │ 8weeks_v3  │    │  328件/回   │                     │
│  └─────────────┘    └─────────────┘    └─────────────┘                     │
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐                                        │
│  │ 毎朝9:00   │───▶│ リマインド   │  ※テストモード（神原・test沙織のみ）      │
│  │ リマインド   │    │ LINE送信   │                                        │
│  └─────────────┘    └─────────────┘                                        │
└─────────────────────────────────────────────────────────────────────────────┘
\`\`\`

---

## 2. 完了機能一覧

### ✅ 2026年1月7-8日 完了

| 機能 | 説明 | 状態 |
|------|------|------|
| RLS有効化 | 全テーブルでRow Level Security有効化 | ✅ 完了 |
| service_roleキー移行 | anon→service_role（JWT形式）に変更 | ✅ 完了 |
| RLSポリシー設定 | 全8テーブルにservice_role_allポリシー追加 | ✅ 完了 |
| salon_staff拡張 | receive_notification, line_idカラム追加 | ✅ 完了 |
| LINE通知先一元化 | salon_staffテーブルで管理（5名登録済み） | ✅ 完了 |
| cancel_booking.py Xvfb追加 | Railway用仮想ディスプレイ対応 | ✅ 完了 |
| 未使用テーブル削除 | absence_requests, salon_bookings削除 | ✅ 完了 |

---

## 3. 未完・進行中機能

| 優先度 | 機能 | 状態 | 詳細 |
|--------|------|------|------|
| 🔴 高 | SalonBoardキャンセル自動実行 | 🔄 進行中 | サブプロセス起動確認中 |
| 🔴 高 | SalonBoard日時変更自動実行 | ⏸️ 保留 | キャンセル完了後に対応 |
| 🟡 中 | リマインド本番移行 | ⏸️ テストモード | 神原・test沙織のみ |
| 🟡 中 | auth_notification_system.py通知先修正 | ⏸️ 保留 | salon_staffから取得に変更予定 |

---

## 4. インフラ構成

### Railway（バックエンド）

| 項目 | 値 |
|------|-----|
| プロジェクト | pacific-insight |
| URL | https://salon-absence-system-production.up.railway.app |
| メインファイル | auth_notification_system.py (4754行) |

### Supabase（データベース）

| 項目 | 値 |
|------|-----|
| プロジェクトID | lsrbeugmqqqklywmvjjs |
| RLS | 全テーブル有効 |
| APIキー | service_role（JWT形式） |

### LINE

| 項目 | 値 |
|------|-----|
| LIFF ID | 2006629229-Y8lb2daA |
| LIFF URL | https://liff.line.me/2006629229-Y8lb2daA |

---

## 5. ファイル構成

\`\`\`
salon-absence-system/
├── auth_notification_system.py  # 4754行 - メインアプリ
├── scrape_8weeks_v3.py          # ★本番スクレイピング
├── cancel_booking.py            # キャンセル処理
├── .env                         # 環境変数
├── session_cookies.json         # SalonBoardクッキー
└── MANUAL_v11.md                # このファイル
\`\`\`

---

## 6. データベース設計

### テーブル一覧（8テーブル）

| テーブル | 件数 | 説明 | RLS |
|----------|------|------|-----|
| customers | 160 | 顧客マスタ | ✅ |
| 8weeks_bookings | 328 | 予約データ（8週間分） | ✅ |
| available_slots | 216 | 空き枠データ | ✅ |
| salon_staff | 5 | スタッフマスタ（通知先含む） | ✅ |
| salon_menus | 45 | メニューマスタ | ✅ |
| salonboard_menus | 48 | SalonBoardメニュー | ✅ |
| message_templates | 3 | メッセージテンプレート | ✅ |
| reminder_logs | 32 | リマインド送信ログ | ✅ |

### salon_staff（通知先一元管理）

| ID | 名前 | receive_notification | LINE ID |
|----|------|---------------------|---------|
| 1 | 中林　香織 | false | - |
| 2 | 太田　由香利 | true | U2c097f177a2c... |
| 3 | 神原良祐 | true | U9022782f0552... |
| 4 | test沙織 | true | U1d1dfe1993f1... |
| 5 | HAL本店１ | true | Ude9ef7ceb8f0... |

---

## 7. フロントエンド（LIFF）

### 画面遷移

\`\`\`
LINE → LIFF起動 → 電話番号確認 → 予約一覧表示
                                    ├─ 日時変更 → メニュー選択 → カレンダー → 変更実行
                                    └─ キャンセル → 確認 → キャンセル実行（🔄進行中）
\`\`\`

---

## 8. バックエンド（Railway）

### 主要APIエンドポイント

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| /liff/booking | GET | LIFF予約確認画面 |
| /api/liff/execute-change | POST | 日時変更実行 |
| /api/liff/cancel-request | POST | キャンセル実行 |
| /admin/staff | GET | スタッフ管理画面 |

---

## 9. スクレイピングシステム

### 本番：scrape_8weeks_v3.py

- 毎分実行（APScheduler）
- 6ワーカー並列処理
- 約328件/55秒

---

## 10. キャンセル・変更自動化

### キャンセル処理（🔄 進行中）

\`\`\`
LIFF「キャンセル」→ /api/liff/cancel-request → subprocess → cancel_booking.py → SalonBoard
\`\`\`

**現在の問題**: サブプロセスのログが出力されない。調査中。

---

## 11. 通知システム

### 通知先一覧

| 機能 | 送信先 | 状態 |
|------|--------|------|
| 日時変更 | 顧客本人 + 神原良祐 | ✅ 本番 |
| キャンセル | 顧客本人 | ✅ 本番 |
| リマインド | 神原・test沙織 | ⏸️ テスト |

---

## 12. セキュリティ設定

- RLS: 全テーブル有効
- APIキー: service_role（JWT形式）
- フロントエンドはAPI経由のみ

---

## 13. 運用手順

### 自動実行

| 時間 | 処理 | 状態 |
|------|------|------|
| 毎分 | スクレイピング | ✅ |
| 毎朝9:00 | リマインド | ⏸️ テスト |
| 毎日 | DBバックアップ | ✅ |

### デプロイ

\`\`\`bash
git add -A && git commit -m "変更内容" && git push
\`\`\`

---

## 14. トラブルシューティング

| 問題 | 解決 |
|------|------|
| スクレイピングエラー | 無視可能（リトライで解決） |
| Cookie無効 | update_cookies.py実行 |
| DB接続エラー | SUPABASE_KEY確認 |

---

**リポジトリ**: https://github.com/ryosukekambara/salon-absence-system (PRIVATE)  
**最新コミット**: 048b76e
